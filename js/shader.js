// koffee 1.6.0

/*
 0000000  000   000   0000000   0000000    00000000  00000000   
000       000   000  000   000  000   000  000       000   000  
0000000   000000000  000000000  000   000  0000000   0000000    
     000  000   000  000   000  000   000  000       000   000  
0000000   000   000  000   000  0000000    00000000  000   000
 */
var MeshBuilder, Shader, ShaderMaterial, Vect, Vector2, clamp, deg2rad, performance, rad2deg, ref, ref1;

ref = require('babylonjs'), MeshBuilder = ref.MeshBuilder, ShaderMaterial = ref.ShaderMaterial, Vector2 = ref.Vector2;

performance = require('perf_hooks').performance;

ref1 = require('kxk'), clamp = ref1.clamp, deg2rad = ref1.deg2rad, rad2deg = ref1.rad2deg;

Vect = require('./vect');

Shader = (function() {
    function Shader(world) {
        var fragmentShader, plane, vertexShader;
        this.world = world;
        this.scene = this.world.scene;
        vertexShader = "precision highp float;\nattribute vec3 position;\nattribute vec2 uv;\nuniform mat4 worldViewProjection;\nvoid main(void) {\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}";
        fragmentShader = "precision highp float;\nuniform float iTime;\nuniform vec2  iMouse;\nuniform vec2  iResolution;\n\n#define MAX_STEPS 128\n#define MIN_DIST  0.01\n#define MAX_DIST  100.0\n\n#define PI 3.141592653589793\n\nfloat rad2deg(float r) { return 180.0 * r / PI; }\nfloat deg2rad(float d) { return PI * d / 180.0; }\n\nvec4 quatAxisAngle(vec3 axis, float angle)\n{ \n  vec4 qr;\n  float half_angle = deg2rad(angle * 0.5);\n  qr.x = axis.x * sin(half_angle);\n  qr.y = axis.y * sin(half_angle);\n  qr.z = axis.z * sin(half_angle);\n  qr.w = cos(half_angle);\n  return qr;\n}\n\nvec4 quatConj(vec4 q)\n{ \n  return vec4(-q.x, -q.y, -q.z, q.w); \n}\n  \nvec4 quatMul(vec4 q1, vec4 q2)\n{ \n  vec4 qr;\n  qr.x = (q1.w * q2.x) + (q1.x * q2.w) + (q1.y * q2.z) - (q1.z * q2.y);\n  qr.y = (q1.w * q2.y) - (q1.x * q2.z) + (q1.y * q2.w) + (q1.z * q2.x);\n  qr.z = (q1.w * q2.z) + (q1.x * q2.y) - (q1.y * q2.x) + (q1.z * q2.w);\n  qr.w = (q1.w * q2.w) - (q1.x * q2.x) - (q1.y * q2.y) - (q1.z * q2.z);\n  return qr;\n}\n\nvec3 rotAxisAngle(vec3 position, vec3 axis, float angle)\n{ \n  vec4 qr = quatAxisAngle(axis, angle);\n  vec4 qr_conj = quatConj(qr);\n  vec4 q_pos = vec4(position.x, position.y, position.z, 0);\n  \n  vec4 q_tmp = quatMul(qr, q_pos);\n  qr = quatMul(q_tmp, qr_conj);\n  \n  return vec3(qr.x, qr.y, qr.z);\n}\n\nvec3 rotY(vec3 v, float deg)\n{\n    float rad = deg2rad(deg);\n    float c = cos(rad);\n    float s = sin(rad);\n    return vec3(v.x*c+v.z*s, v.y, v.z*c+v.x*s);\n}\n\nfloat sdCapsule(vec3 p, vec3 a, vec3 b, float r)\n{\n    vec3 ab = b-a;\n    vec3 ap = p-a;\n    float t = dot(ab,ap) / dot(ab,ab);\n    t = clamp(t, 0.0, 1.0);\n    vec3 c = a + t*ab;\n    return length(p-c)-r;        \n}\n\nfloat sdSphere(vec3 p, vec3 a, float r)\n{\n    return length(p-a)-r;\n}\n\nfloat sdPlane(vec3 p, vec3 a, vec3 n)\n{   \n    return dot(n, p-a);\n}\n\nfloat getDist(vec3 p)\n{\n    float m = 1000.0;\n    \n    vec3 p2 = rotY(vec3(0,1,-5), iTime*36.0);\n    vec3 p3 = rotAxisAngle(vec3(0,1,-5), vec3(1,1,0), iTime*36.0);\n    \n    m = min(m, sdSphere(p, vec3(0,1,0), 1.0));\n    m = min(m, sdCapsule(p, vec3(0,1,0), p2, 0.2));\n    m = min(m, sdCapsule(p, vec3(0,1,0), p3, 0.2));\n    m = min(m, sdPlane(p, vec3(0,-.5,0), vec3(0,1,0)));\n    return m;\n}\n\nvec3 getNormal(vec3 p)\n{\n    float d = getDist(p);\n    vec2 e = vec2(0.01, 0);\n    vec3 n = d - vec3(getDist(p-e.xyy), getDist(p-e.yxy), getDist(p-e.yyx));\n    return normalize(n);\n}\n\nfloat rayMarch(vec3 ro, vec3 rd)\n{\n    float dz = 0.0;\n    for (int i = 0; i < MAX_STEPS; i++)\n    {\n        vec3 p = ro + dz * rd;\n        float dp = getDist(p);\n        dz += dp;\n        if (dp < MIN_DIST || dz > MAX_DIST) break;\n    }\n    return dz;\n}\n\nfloat softShadow( in vec3 ro, in vec3 rd, float tmin, float tmax, const float w )\n{\n    float t = tmin;\n    float res = 1.0;\n    for( int i=0; i<256; i++ )\n    {\n        float h = getDist(ro + t*rd);\n        res = min( res, h/(w*t) );\n        t += clamp(h, 0.005, 0.50);\n        if ( res<-1.0 || t>tmax ) break;\n    }\n\n    res = max(res,-1.0); \n\n    return 0.25*(1.0+res)*(1.0+res)*(2.0-res);\n}\n\nfloat getLight(vec3 p)\n{\n    float t = iTime*1.0;\n    vec3 lp = rotY(vec3(0, 10, -10), iTime*36.0);\n    vec3 l = normalize(lp - p);\n    vec3 n = getNormal(p);\n \n    float dif = dot(n,l);\n    \n    vec3 off = p+n*2.0*MIN_DIST;\n\n    dif *= softShadow(off, normalize(lp-off), MIN_DIST, 10.0, 0.3);\n        \n    return clamp(dif, 0.0, 1.0);\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = (fragCoord-.5*iResolution.xy)/iResolution.y;\n    \n    float an = 2.0*PI*iMouse.x/iResolution.x-0.5;\n    vec3 ro  = vec3(10.0*cos(an), 1, -10.0*sin(an));\n    vec3 ct  = vec3(0,2,0);\n\n    vec3 ww = normalize(ct-ro);\n    vec3 uu = normalize(cross(ww, vec3(0,1,0)));\n    vec3 vv = normalize(cross(uu, ww));\n    \n    vec3 rd = normalize(uv.x*uu + uv.y*vv + 1.5*ww);\n    \n    float f = rayMarch(ro, rd);\n    \n    vec3 p = ro + f * rd;\n    \n    fragColor = vec4(getLight(p), iMouse.x/iResolution.x, iMouse.y/iResolution.y, 1.0);\n}\n                        \nvoid main(void) \n{\n    mainImage(gl_FragColor, gl_FragCoord.xy);\n}";
        this.shaderMaterial = new ShaderMaterial("shader", this.scene, {
            fragmentSource: fragmentShader,
            vertexSource: vertexShader
        }, {
            attributes: ['position', 'normal', 'uv'],
            uniforms: ['worldViewProjection', 'iTime', 'iMouse', 'iResolution']
        });
        plane = MeshBuilder.CreatePlane("plane", {
            width: 100,
            height: 100
        }, this.scene);
        plane.material = this.shaderMaterial;
    }

    Shader.prototype.render = function() {
        this.shaderMaterial.setFloat('iTime', performance.now() / 1000);
        this.shaderMaterial.setVector2('iMouse', new Vector2(this.world.camera.mouseX, this.world.canvas.height - this.world.camera.mouseY));
        return this.shaderMaterial.setVector2('iResolution', new Vector2(this.world.canvas.width, this.world.canvas.height));
    };

    return Shader;

})();

module.exports = Shader;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZGVyLmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7O0FBQUEsSUFBQTs7QUFRQSxNQUEyQyxPQUFBLENBQVEsV0FBUixDQUEzQyxFQUFFLDZCQUFGLEVBQWUsbUNBQWYsRUFBK0I7O0FBQzdCLGNBQWdCLE9BQUEsQ0FBUSxZQUFSOztBQUNsQixPQUE4QixPQUFBLENBQVEsS0FBUixDQUE5QixFQUFFLGtCQUFGLEVBQVMsc0JBQVQsRUFBa0I7O0FBQ2xCLElBQUEsR0FBTyxPQUFBLENBQVEsUUFBUjs7QUFFRDtJQUVDLGdCQUFDLEtBQUQ7QUFFQyxZQUFBO1FBRkEsSUFBQyxDQUFBLFFBQUQ7UUFFQSxJQUFDLENBQUEsS0FBRCxHQUFTLElBQUMsQ0FBQSxLQUFLLENBQUM7UUFFaEIsWUFBQSxHQUFnQjtRQVVoQixjQUFBLEdBQWlCO1FBZ0xqQixJQUFDLENBQUEsY0FBRCxHQUFrQixJQUFJLGNBQUosQ0FBbUIsUUFBbkIsRUFBNkIsSUFBQyxDQUFBLEtBQTlCLEVBQXFDO1lBQy9DLGNBQUEsRUFBZSxjQURnQztZQUUvQyxZQUFBLEVBQWEsWUFGa0M7U0FBckMsRUFHWjtZQUNFLFVBQUEsRUFBWSxDQUFDLFVBQUQsRUFBWSxRQUFaLEVBQXFCLElBQXJCLENBRGQ7WUFFRSxRQUFBLEVBQVksQ0FBQyxxQkFBRCxFQUF1QixPQUF2QixFQUErQixRQUEvQixFQUF3QyxhQUF4QyxDQUZkO1NBSFk7UUFRbEIsS0FBQSxHQUFRLFdBQVcsQ0FBQyxXQUFaLENBQXdCLE9BQXhCLEVBQWlDO1lBQUUsS0FBQSxFQUFPLEdBQVQ7WUFBYyxNQUFBLEVBQVEsR0FBdEI7U0FBakMsRUFBOEQsSUFBQyxDQUFBLEtBQS9EO1FBQ1IsS0FBSyxDQUFDLFFBQU4sR0FBaUIsSUFBQyxDQUFBO0lBdk1uQjs7cUJBeU1ILE1BQUEsR0FBUSxTQUFBO1FBRUosSUFBQyxDQUFBLGNBQWMsQ0FBQyxRQUFoQixDQUEyQixPQUEzQixFQUFtQyxXQUFXLENBQUMsR0FBWixDQUFBLENBQUEsR0FBa0IsSUFBckQ7UUFDQSxJQUFDLENBQUEsY0FBYyxDQUFDLFVBQWhCLENBQTJCLFFBQTNCLEVBQXlDLElBQUksT0FBSixDQUFZLElBQUMsQ0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQTFCLEVBQWtDLElBQUMsQ0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQWQsR0FBcUIsSUFBQyxDQUFBLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBckUsQ0FBekM7ZUFDQSxJQUFDLENBQUEsY0FBYyxDQUFDLFVBQWhCLENBQTJCLGFBQTNCLEVBQXlDLElBQUksT0FBSixDQUFZLElBQUMsQ0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQTFCLEVBQWlDLElBQUMsQ0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQS9DLENBQXpDO0lBSkk7Ozs7OztBQU1aLE1BQU0sQ0FBQyxPQUFQLEdBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiIyMjXG4gMDAwMDAwMCAgMDAwICAgMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAgICAgMDAwMDAwMDAgIDAwMDAwMDAwICAgXG4wMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgXG4wMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgIDAwMDAwMDAgICAgXG4gICAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgXG4wMDAwMDAwICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAgICAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4jIyNcblxueyBNZXNoQnVpbGRlciwgU2hhZGVyTWF0ZXJpYWwsIFZlY3RvcjIgfSA9IHJlcXVpcmUgJ2JhYnlsb25qcydcbnsgcGVyZm9ybWFuY2UgfSA9IHJlcXVpcmUgJ3BlcmZfaG9va3MnXG57IGNsYW1wLCBkZWcycmFkLCByYWQyZGVnIH0gPSByZXF1aXJlICdreGsnXG5WZWN0ID0gcmVxdWlyZSAnLi92ZWN0J1xuICAgICAgICBcbmNsYXNzIFNoYWRlclxuICAgIFxuICAgIEA6IChAd29ybGQpIC0+XG5cbiAgICAgICAgQHNjZW5lID0gQHdvcmxkLnNjZW5lXG4gICAgICAgIFxuICAgICAgICB2ZXJ0ZXhTaGFkZXIgPSAgXCJcIlwiXG4gICAgICAgICAgICBwcmVjaXNpb24gaGlnaHAgZmxvYXQ7XG4gICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMyBwb3NpdGlvbjtcbiAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMyIHV2O1xuICAgICAgICAgICAgdW5pZm9ybSBtYXQ0IHdvcmxkVmlld1Byb2plY3Rpb247XG4gICAgICAgICAgICB2b2lkIG1haW4odm9pZCkge1xuICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gd29ybGRWaWV3UHJvamVjdGlvbiAqIHZlYzQocG9zaXRpb24sIDEuMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcIlwiXCJcbiAgICAgICAgXHJcbiAgICAgICAgZnJhZ21lbnRTaGFkZXIgPSBcIlwiXCJcbiAgICAgICAgICAgIHByZWNpc2lvbiBoaWdocCBmbG9hdDtcbiAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgaVRpbWU7XG4gICAgICAgICAgICB1bmlmb3JtIHZlYzIgIGlNb3VzZTtcbiAgICAgICAgICAgIHVuaWZvcm0gdmVjMiAgaVJlc29sdXRpb247XG4gICAgICAgICAgICBcbiAgICAgICAgICAgICNkZWZpbmUgTUFYX1NURVBTIDEyOFxyXG4gICAgICAgICAgICAjZGVmaW5lIE1JTl9ESVNUICAwLjAxXHJcbiAgICAgICAgICAgICNkZWZpbmUgTUFYX0RJU1QgIDEwMC4wXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAjZGVmaW5lIFBJIDMuMTQxNTkyNjUzNTg5NzkzXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBmbG9hdCByYWQyZGVnKGZsb2F0IHIpIHsgcmV0dXJuIDE4MC4wICogciAvIFBJOyB9XHJcbiAgICAgICAgICAgIGZsb2F0IGRlZzJyYWQoZmxvYXQgZCkgeyByZXR1cm4gUEkgKiBkIC8gMTgwLjA7IH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZlYzQgcXVhdEF4aXNBbmdsZSh2ZWMzIGF4aXMsIGZsb2F0IGFuZ2xlKVxyXG4gICAgICAgICAgICB7IFxyXG4gICAgICAgICAgICAgIHZlYzQgcXI7XHJcbiAgICAgICAgICAgICAgZmxvYXQgaGFsZl9hbmdsZSA9IGRlZzJyYWQoYW5nbGUgKiAwLjUpO1xyXG4gICAgICAgICAgICAgIHFyLnggPSBheGlzLnggKiBzaW4oaGFsZl9hbmdsZSk7XHJcbiAgICAgICAgICAgICAgcXIueSA9IGF4aXMueSAqIHNpbihoYWxmX2FuZ2xlKTtcclxuICAgICAgICAgICAgICBxci56ID0gYXhpcy56ICogc2luKGhhbGZfYW5nbGUpO1xyXG4gICAgICAgICAgICAgIHFyLncgPSBjb3MoaGFsZl9hbmdsZSk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHFyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2ZWM0IHF1YXRDb25qKHZlYzQgcSlcclxuICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICByZXR1cm4gdmVjNCgtcS54LCAtcS55LCAtcS56LCBxLncpOyBcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2ZWM0IHF1YXRNdWwodmVjNCBxMSwgdmVjNCBxMilcclxuICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICB2ZWM0IHFyO1xyXG4gICAgICAgICAgICAgIHFyLnggPSAocTEudyAqIHEyLngpICsgKHExLnggKiBxMi53KSArIChxMS55ICogcTIueikgLSAocTEueiAqIHEyLnkpO1xyXG4gICAgICAgICAgICAgIHFyLnkgPSAocTEudyAqIHEyLnkpIC0gKHExLnggKiBxMi56KSArIChxMS55ICogcTIudykgKyAocTEueiAqIHEyLngpO1xyXG4gICAgICAgICAgICAgIHFyLnogPSAocTEudyAqIHEyLnopICsgKHExLnggKiBxMi55KSAtIChxMS55ICogcTIueCkgKyAocTEueiAqIHEyLncpO1xyXG4gICAgICAgICAgICAgIHFyLncgPSAocTEudyAqIHEyLncpIC0gKHExLnggKiBxMi54KSAtIChxMS55ICogcTIueSkgLSAocTEueiAqIHEyLnopO1xyXG4gICAgICAgICAgICAgIHJldHVybiBxcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmVjMyByb3RBeGlzQW5nbGUodmVjMyBwb3NpdGlvbiwgdmVjMyBheGlzLCBmbG9hdCBhbmdsZSlcclxuICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICB2ZWM0IHFyID0gcXVhdEF4aXNBbmdsZShheGlzLCBhbmdsZSk7XHJcbiAgICAgICAgICAgICAgdmVjNCBxcl9jb25qID0gcXVhdENvbmoocXIpO1xyXG4gICAgICAgICAgICAgIHZlYzQgcV9wb3MgPSB2ZWM0KHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHBvc2l0aW9uLnosIDApO1xyXG4gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgIHZlYzQgcV90bXAgPSBxdWF0TXVsKHFyLCBxX3Bvcyk7XHJcbiAgICAgICAgICAgICAgcXIgPSBxdWF0TXVsKHFfdG1wLCBxcl9jb25qKTtcclxuICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICByZXR1cm4gdmVjMyhxci54LCBxci55LCBxci56KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmVjMyByb3RZKHZlYzMgdiwgZmxvYXQgZGVnKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCByYWQgPSBkZWcycmFkKGRlZyk7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCBjID0gY29zKHJhZCk7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHJhZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmVjMyh2LngqYyt2Lnoqcywgdi55LCB2LnoqYyt2Lngqcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZsb2F0IHNkQ2Fwc3VsZSh2ZWMzIHAsIHZlYzMgYSwgdmVjMyBiLCBmbG9hdCByKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB2ZWMzIGFiID0gYi1hO1xyXG4gICAgICAgICAgICAgICAgdmVjMyBhcCA9IHAtYTtcclxuICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkb3QoYWIsYXApIC8gZG90KGFiLGFiKTtcclxuICAgICAgICAgICAgICAgIHQgPSBjbGFtcCh0LCAwLjAsIDEuMCk7XHJcbiAgICAgICAgICAgICAgICB2ZWMzIGMgPSBhICsgdCphYjtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGgocC1jKS1yOyAgICAgICAgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZsb2F0IHNkU3BoZXJlKHZlYzMgcCwgdmVjMyBhLCBmbG9hdCByKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVuZ3RoKHAtYSktcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZmxvYXQgc2RQbGFuZSh2ZWMzIHAsIHZlYzMgYSwgdmVjMyBuKVxyXG4gICAgICAgICAgICB7ICAgXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZG90KG4sIHAtYSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZsb2F0IGdldERpc3QodmVjMyBwKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCBtID0gMTAwMC4wO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2ZWMzIHAyID0gcm90WSh2ZWMzKDAsMSwtNSksIGlUaW1lKjM2LjApO1xyXG4gICAgICAgICAgICAgICAgdmVjMyBwMyA9IHJvdEF4aXNBbmdsZSh2ZWMzKDAsMSwtNSksIHZlYzMoMSwxLDApLCBpVGltZSozNi4wKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgbSA9IG1pbihtLCBzZFNwaGVyZShwLCB2ZWMzKDAsMSwwKSwgMS4wKSk7XHJcbiAgICAgICAgICAgICAgICBtID0gbWluKG0sIHNkQ2Fwc3VsZShwLCB2ZWMzKDAsMSwwKSwgcDIsIDAuMikpO1xyXG4gICAgICAgICAgICAgICAgbSA9IG1pbihtLCBzZENhcHN1bGUocCwgdmVjMygwLDEsMCksIHAzLCAwLjIpKTtcclxuICAgICAgICAgICAgICAgIG0gPSBtaW4obSwgc2RQbGFuZShwLCB2ZWMzKDAsLS41LDApLCB2ZWMzKDAsMSwwKSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZlYzMgZ2V0Tm9ybWFsKHZlYzMgcClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgZmxvYXQgZCA9IGdldERpc3QocCk7XHJcbiAgICAgICAgICAgICAgICB2ZWMyIGUgPSB2ZWMyKDAuMDEsIDApO1xyXG4gICAgICAgICAgICAgICAgdmVjMyBuID0gZCAtIHZlYzMoZ2V0RGlzdChwLWUueHl5KSwgZ2V0RGlzdChwLWUueXh5KSwgZ2V0RGlzdChwLWUueXl4KSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9ybWFsaXplKG4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBmbG9hdCByYXlNYXJjaCh2ZWMzIHJvLCB2ZWMzIHJkKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCBkeiA9IDAuMDtcclxuICAgICAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgTUFYX1NURVBTOyBpKyspXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmVjMyBwID0gcm8gKyBkeiAqIHJkO1xyXG4gICAgICAgICAgICAgICAgICAgIGZsb2F0IGRwID0gZ2V0RGlzdChwKTtcclxuICAgICAgICAgICAgICAgICAgICBkeiArPSBkcDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZHAgPCBNSU5fRElTVCB8fCBkeiA+IE1BWF9ESVNUKSBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBkejtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZmxvYXQgc29mdFNoYWRvdyggaW4gdmVjMyBybywgaW4gdmVjMyByZCwgZmxvYXQgdG1pbiwgZmxvYXQgdG1heCwgY29uc3QgZmxvYXQgdyApXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB0bWluO1xyXG4gICAgICAgICAgICAgICAgZmxvYXQgcmVzID0gMS4wO1xyXG4gICAgICAgICAgICAgICAgZm9yKCBpbnQgaT0wOyBpPDI1NjsgaSsrIClcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBmbG9hdCBoID0gZ2V0RGlzdChybyArIHQqcmQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcyA9IG1pbiggcmVzLCBoLyh3KnQpICk7XHJcbiAgICAgICAgICAgICAgICAgICAgdCArPSBjbGFtcChoLCAwLjAwNSwgMC41MCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCByZXM8LTEuMCB8fCB0PnRtYXggKSBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICByZXMgPSBtYXgocmVzLC0xLjApOyBcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMC4yNSooMS4wK3JlcykqKDEuMCtyZXMpKigyLjAtcmVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZmxvYXQgZ2V0TGlnaHQodmVjMyBwKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBmbG9hdCB0ID0gaVRpbWUqMS4wO1xyXG4gICAgICAgICAgICAgICAgdmVjMyBscCA9IHJvdFkodmVjMygwLCAxMCwgLTEwKSwgaVRpbWUqMzYuMCk7XHJcbiAgICAgICAgICAgICAgICB2ZWMzIGwgPSBub3JtYWxpemUobHAgLSBwKTtcclxuICAgICAgICAgICAgICAgIHZlYzMgbiA9IGdldE5vcm1hbChwKTtcclxuICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZmxvYXQgZGlmID0gZG90KG4sbCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHZlYzMgb2ZmID0gcCtuKjIuMCpNSU5fRElTVDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBkaWYgKj0gc29mdFNoYWRvdyhvZmYsIG5vcm1hbGl6ZShscC1vZmYpLCBNSU5fRElTVCwgMTAuMCwgMC4zKTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHJldHVybiBjbGFtcChkaWYsIDAuMCwgMS4wKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdm9pZCBtYWluSW1hZ2UoIG91dCB2ZWM0IGZyYWdDb2xvciwgaW4gdmVjMiBmcmFnQ29vcmQgKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gKGZyYWdDb29yZC0uNSppUmVzb2x1dGlvbi54eSkvaVJlc29sdXRpb24ueTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZmxvYXQgYW4gPSAyLjAqUEkqaU1vdXNlLngvaVJlc29sdXRpb24ueC0wLjU7XHJcbiAgICAgICAgICAgICAgICB2ZWMzIHJvICA9IHZlYzMoMTAuMCpjb3MoYW4pLCAxLCAtMTAuMCpzaW4oYW4pKTtcclxuICAgICAgICAgICAgICAgIHZlYzMgY3QgID0gdmVjMygwLDIsMCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgdmVjMyB3dyA9IG5vcm1hbGl6ZShjdC1ybyk7XHJcbiAgICAgICAgICAgICAgICB2ZWMzIHV1ID0gbm9ybWFsaXplKGNyb3NzKHd3LCB2ZWMzKDAsMSwwKSkpO1xyXG4gICAgICAgICAgICAgICAgdmVjMyB2diA9IG5vcm1hbGl6ZShjcm9zcyh1dSwgd3cpKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgdmVjMyByZCA9IG5vcm1hbGl6ZSh1di54KnV1ICsgdXYueSp2diArIDEuNSp3dyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGZsb2F0IGYgPSByYXlNYXJjaChybywgcmQpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2ZWMzIHAgPSBybyArIGYgKiByZDtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZnJhZ0NvbG9yID0gdmVjNChnZXRMaWdodChwKSwgaU1vdXNlLngvaVJlc29sdXRpb24ueCwgaU1vdXNlLnkvaVJlc29sdXRpb24ueSwgMS4wKTtcclxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB2b2lkIG1haW4odm9pZCkgXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWFpbkltYWdlKGdsX0ZyYWdDb2xvciwgZ2xfRnJhZ0Nvb3JkLnh5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFwiXCJcIlxuICAgICAgICAgICAgICAgIFxuICAgICAgICBAc2hhZGVyTWF0ZXJpYWwgPSBuZXcgU2hhZGVyTWF0ZXJpYWwgXCJzaGFkZXJcIiwgQHNjZW5lLCB7IFxuICAgICAgICAgICAgICAgIGZyYWdtZW50U291cmNlOmZyYWdtZW50U2hhZGVyXG4gICAgICAgICAgICAgICAgdmVydGV4U291cmNlOnZlcnRleFNoYWRlclxuICAgICAgICAgICAgfSxccntcclxuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IFsncG9zaXRpb24nICdub3JtYWwnICd1diddXG4gICAgICAgICAgICAgICAgdW5pZm9ybXM6ICAgWyd3b3JsZFZpZXdQcm9qZWN0aW9uJyAnaVRpbWUnICdpTW91c2UnICdpUmVzb2x1dGlvbiddXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgcGxhbmUgPSBNZXNoQnVpbGRlci5DcmVhdGVQbGFuZSBcInBsYW5lXCIsIHsgd2lkdGg6IDEwMCwgaGVpZ2h0OiAxMDAgfSwgQHNjZW5lXG4gICAgICAgIHBsYW5lLm1hdGVyaWFsID0gQHNoYWRlck1hdGVyaWFsXG4gICAgICAgICAgIFxuICAgIHJlbmRlcjogLT5cbiAgICAgICAgXG4gICAgICAgIEBzaGFkZXJNYXRlcmlhbC5zZXRGbG9hdCAgICdpVGltZScgcGVyZm9ybWFuY2Uubm93KCkvMTAwMFxuICAgICAgICBAc2hhZGVyTWF0ZXJpYWwuc2V0VmVjdG9yMiAnaU1vdXNlJyAgICAgIG5ldyBWZWN0b3IyKEB3b3JsZC5jYW1lcmEubW91c2VYLCBAd29ybGQuY2FudmFzLmhlaWdodC1Ad29ybGQuY2FtZXJhLm1vdXNlWSlcbiAgICAgICAgQHNoYWRlck1hdGVyaWFsLnNldFZlY3RvcjIgJ2lSZXNvbHV0aW9uJyBuZXcgVmVjdG9yMihAd29ybGQuY2FudmFzLndpZHRoLCBAd29ybGQuY2FudmFzLmhlaWdodClcbiAgICAgICAgICAgICAgICBcbm1vZHVsZS5leHBvcnRzID0gU2hhZGVyXG4iXX0=
//# sourceURL=../coffee/shader.coffee